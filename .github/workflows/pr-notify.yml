name: pr-notify.yml

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Check and notify
        run: |
          # æ£€æŸ¥å®¡æŸ¥è€…
          REVIEWERS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}" | \
            jq '(.requested_reviewers | length) + (.requested_teams | length)')
          if [ "$REVIEWERS" -eq 0 ]; then
            echo "æ— å®¡æŸ¥è€…ï¼Œè·³è¿‡é€šçŸ¥"
            exit 0
          fi
          
          
          
          
          # è·å–è¯„å®¡äººåˆ—è¡¨
          REVIEWER_NAMES=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}" | \
            jq -r '.requested_reviewers[].login' | tr '\n' ',' | sed 's/,$//')
          # æ„å»ºæ¶ˆæ¯å†…å®¹
          MESSAGE="âš¡ PR ${{ github.event.action }} - éœ€è¦å®¡æŸ¥\\n"
          MESSAGE+="ğŸ¯ æ ‡é¢˜: ${{ github.event.pull_request.title }}\\n"
          MESSAGE+="âœï¸ ä½œè€…: ${{ github.event.pull_request.user.login }}\\n"
          MESSAGE+="ğŸ  ä»“åº“: ${{ github.repository }}\\n"
          MESSAGE+="ğŸŒ é“¾æ¥: ${{ github.event.pull_request.html_url }}\\n"
          MESSAGE+="ğŸ” è¯„å®¡äºº: ${REVIEWER_NAMES}"
          # å‘é€é€šçŸ¥
          curl -X POST "${{ secrets.FEISHU_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"msg_type\": \"text\",
              \"content\": {
                \"text\": \"${MESSAGE}\"
              }
            }"
